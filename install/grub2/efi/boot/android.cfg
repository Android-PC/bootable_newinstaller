# $1 Title
# $2... Kernel cmdline
function add_entry {
	menuentry "Android-x86 VER $1" "$@" --class android-x86 {
		shift 2
		savedefault
		set root=$android
		linux $kdir/kernel CMDLINE $src $@
		initrd $kdir/initrd.img
	}
}

# $1 EFI to chainload
# $2 OS name
# $3 Class
function add_os_if_exists {
#	search --no-floppy --set -f $1
	if [ -e ($root)/$1 ]; then
		menuentry "$2 ->" "$1" --class "$3" {
			savedefault
			chainloader ($root)/$2
		}
	fi
}

function savedefault {
	if [ -s $prefix/grubenv -a "$chosen" != "$default" ]; then
		set default="$chosen"
		save_env default
	fi
}

if [ -s $prefix/grubenv ]; then
	load_env
fi

search --no-floppy --set android -f $kdir/kernel
export android kdir live src

# Create main menu
add_entry "$live" quiet
add_entry "$debug_mode" DEBUG=2
if [ -s ($android)$kdir/install.img ]; then
	add_entry "Installation" INSTALL=1
fi

submenu "Advanced options -> " {
	add_entry "$live - No Hardware Acceleration" quiet nomodeset HWACCEL=0
	if [ -s ($android)$kdir/install.img ]; then
		add_entry "Auto Install to first harddisk" AUTO_INSTALL=1
		add_entry "Auto Update" AUTO_INSTALL=update
	fi
	if [ "$grub_cpu" != "i386" ]; then
		menuentry "Reboot" { reboot }
		menuentry "Poweroff" { halt }
		menuentry "UEFI BIOS Setup" { fwsetup }
	fi
}

if [ "$grub_cpu" = "i386" ]; then
	set grub=grubia32
else
	set grub=grubx64
fi

# Add other OSes boot loaders if exist
add_os_if_exists /EFI/fedora/${grub}.efi Fedora fedora
add_os_if_exists /EFI/ubuntu/${grub}.efi Ubuntu ubuntu
add_os_if_exists /EFI/Microsoft/Boot/bootmgfw.efi Windows windows

for d in $config_directory $cmdpath $prefix; do
	if [ -f $d/custom.cfg ]; then
		source $d/custom.cfg
	fi
done
